services:
  cube:
    build:
      context: ./cube
      dockerfile: Dockerfile
    ports:
      - "42000:4000"
    environment:
      - CUBEJS_DEV_MODE=true
      - CUBEJS_DB_TYPE=duckdb
      - CUBEJS_DB_DUCKDB_DATABASE_PATH=/cube/data/store.duckdb
      - CUBEJS_API_SECRET=cube-explorer-dev-secret
      - CUBEJS_EXTERNAL_DEFAULT=true
      - CUBEJS_SCHEDULED_REFRESH_DEFAULT=true
      - CUBEJS_WEB_SOCKETS=true
    volumes:
      - cube-data:/cube/data
    depends_on:
      seed:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://localhost:4000/readyz', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 10s
      timeout: 5s
      retries: 5

  seed:
    build:
      context: ./seed
      dockerfile: Dockerfile
    volumes:
      - cube-data:/data

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "52000:5173"
    environment:
      - VITE_CUBE_API_URL=http://localhost:42000/cubejs-api/v1
      - VITE_CUBE_API_TOKEN=cube-explorer-dev-secret
    depends_on:
      cube:
        condition: service_healthy

volumes:
  cube-data:
